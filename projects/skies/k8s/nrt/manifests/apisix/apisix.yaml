apiVersion: v1
kind: ConfigMap
metadata:
  name: apisix-config
data:
  config.yaml: |
    apisix:
      node_listen: 9080
      enable_reuseport: true
      enable_ipv6: false
      stream_proxy:
        only: false
        tcp:
          - 9100
      ssl:
        listen_port: 9443
        ssl_protocols: "TLSv1.2 TLSv1.3"
      enable_admin: true
      admin_listen:
        ip: 0.0.0.0
        port: 9180
      enable_dev_mode: false
      show_profile_response_header: true
    etcd:
      host:
        - "http://127.0.0.1:2379"
      timeout: 30
    discovery:
      kubernetes:
        service:
          schema: http
          host: "127.0.0.1"
          port: 6379

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apisix
spec:
  replicas: 1
  selector:
    matchLabels:
      skies/group: infra
      app: apisix
  template:
    metadata:
      labels:
        skies/group: infra
        app: apisix
    spec:
      nodeSelector:
        skies/node-role: app
      serviceAccountName: apisix
      containers:
        - name: apisix
          image: apache/apisix:3.14.1-debian
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 9080
              name: http
            - containerPort: 9443
              name: https
            - containerPort: 9180
              name: admin
            - containerPort: 9100
              name: stream-tcp
          env:
            - name: TZ
              value: UTC
          volumeMounts:
            - name: apisix-config
              mountPath: /usr/local/apisix/conf/config.yaml
              subPath: config.yaml
          livenessProbe:
            httpGet:
              path: /apisix/admin/ping
              port: 9180
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /apisix/admin/ping
              port: 9180
            initialDelaySeconds: 5
            periodSeconds: 5
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
      volumes:
        - name: apisix-config
          configMap:
            name: apisix-config

---
apiVersion: v1
kind: Service
metadata:
  name: apisix
spec:
  selector:
    app: apisix
  type: NodePort
  ports:
    - port: 9080
      targetPort: 9080
      nodePort: 31502
      protocol: TCP
      name: http
    - port: 9443
      targetPort: 9443
      nodePort: 31503
      protocol: TCP
      name: https
    - port: 9180
      targetPort: 9180
      nodePort: 31504
      protocol: TCP
      name: admin
    - port: 9100
      targetPort: 9100
      nodePort: 31505
      protocol: TCP
      name: stream-tcp

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: apisix

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: apisix
rules:
  - apiGroups: [""]
    resources: ["services", "endpoints", "configmaps"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get"]
  - apiGroups: ["apisix.apache.org"]
    resources: ["apisixroutes", "apisixtlses", "apisixupstreams", "apisixclusterconfigs"]
    verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: apisix
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: apisix
subjects:
  - kind: ServiceAccount
    name: apisix
    namespace: default

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: apisix
spec:
  podSelector:
    matchLabels:
      app: apisix
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 9080
        - protocol: TCP
          port: 9443
        - protocol: TCP
          port: 9180
        - protocol: TCP
          port: 9100
  egress:
    - to:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 2379
